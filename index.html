<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gallxs CC - Aplicaci√≥n m√≥vil para el equipo de entrenamiento">
  <meta name="theme-color" content="#000000">
  <title>Gallxs CC - Mobile App</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdhbGx4cyBDQyAtIE1vYmlsZSBBcHAiLAogICJzaG9ydF9uYW1lIjogIkdhbGx4cyBDQyIsCiAgImRlc2NyaXB0aW9uIjogIkFwbGljYWNpw7NuIG3Ds3ZpbCBwYXJhIGVsIGVxdWlwbyBkZSBlbnRyZW5hbWllbnRvIEdhbGx4cyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiMwMDAwMDAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIweG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUyMHdpZHRoPScxOTInJTIwaGVpZ2h0PScxOTInJTNFJTNDcmVjdCUyMHdpZHRoPScxOTInJTIwaGVpZ2h0PScxOTInJTIwZmlsbD0nJTIzMDAwMDAwJy8lM0UlM0NjaXJjbGUlMjBjeD0nOTYnJTIwY3k9Jzk2JyUyMHI9JzgwJyUyMGZpbGw9JyUyM2ZmZmZmZicvJTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow-x: hidden;
    }
    
    @keyframes pulse-green {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
      }
    }
    
    @keyframes pulse-red {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
      }
    }
    
    .pulse-green {
      animation: pulse-green 2s infinite;
    }
    
    .pulse-red {
      animation: pulse-red 2s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SHEET_ID = '1qs4urivhp8Huv1BasaMNHjZwe43-C2P_sDfwzXKYQMw';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzhl3TIrT7uP4XWR4IP8m_jErMVtePxwdhzpF-HrZjr1GfU42YOF1PhmdAg7eXBlWsq/exec';

    // Iconos SVG
    const HomeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    );

    const SettingsIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m-1 1l-4.2 4.2m12.4-1.2l-4.2-4.2m-1-1l-4.2-4.2"></path>
      </svg>
    );

    const UserPlusIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="8.5" cy="7" r="4"></circle>
        <line x1="20" y1="8" x2="20" y2="14"></line>
        <line x1="23" y1="11" x2="17" y2="11"></line>
      </svg>
    );

    const QrCodeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
    );

    const BikeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="18.5" cy="17.5" r="3.5"></circle>
        <circle cx="5.5" cy="17.5" r="3.5"></circle>
        <circle cx="15" cy="5" r="1"></circle>
        <path d="M12 17.5V14l-3-3 4-3 2 3h2"></path>
      </svg>
    );

    const AlertIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    );

    // Componente de Registro
    const RegisterScreen = ({ onBack }) => {
      const [email, setEmail] = useState('');
      const [suggestions, setSuggestions] = useState([]);
      const [allUsers, setAllUsers] = useState([]);
      const [formData, setFormData] = useState({
        nombreCompleto: '',
        nickname: '',
        id: '',
        telefono: '',
        nombreContactoEmergencia: '',
        telefonoEmergencia: '',
        direccionEmergencia: '',
        tipoSangre: '',
        alergias: '',
        observaciones: ''
      });
      const [isExistingUser, setIsExistingUser] = useState(false);
      const [loading, setLoading] = useState(false);
      const [showForm, setShowForm] = useState(false);

      useEffect(() => {
        loadUsers();
      }, []);

      const loadUsers = async () => {
        try {
          const response = await fetch(SHEET_URL);
          const text = await response.text();
          const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
          if (!jsonString) return;
          
          const json = JSON.parse(jsonString[1]);
          const rows = json.table.rows;
          
          const users = rows.map(row => ({
            email: row.c[0]?.v || '',
            nombreCompleto: row.c[1]?.v || '',
            nickname: row.c[2]?.v || '',
            id: row.c[3]?.v || '',
            telefono: row.c[4]?.v || '',
            nombreContactoEmergencia: row.c[5]?.v || '',
            telefonoEmergencia: row.c[6]?.v || '',
            direccionEmergencia: row.c[7]?.v || '',
            tipoSangre: row.c[8]?.v || '',
            alergias: row.c[9]?.v || '',
            observaciones: row.c[10]?.v || ''
          })).filter(u => u.email);
          
          setAllUsers(users);
        } catch (error) {
          console.error('Error loading users:', error);
        }
      };

      const handleEmailChange = (value) => {
        setEmail(value);
        
        if (value.length > 2) {
          const filtered = allUsers.filter(user => 
            user.email.toLowerCase().includes(value.toLowerCase())
          );
          setSuggestions(filtered);
        } else {
          setSuggestions([]);
        }
      };

      const selectEmail = (user) => {
        setEmail(user.email);
        setFormData({
          nombreCompleto: user.nombreCompleto,
          nickname: user.nickname,
          id: user.id,
          telefono: user.telefono,
          nombreContactoEmergencia: user.nombreContactoEmergencia,
          telefonoEmergencia: user.telefonoEmergencia,
          direccionEmergencia: user.direccionEmergencia,
          tipoSangre: user.tipoSangre,
          alergias: user.alergias,
          observaciones: user.observaciones
        });
        setIsExistingUser(true);
        setShowForm(true);
        setSuggestions([]);
      };

      const handleContinue = () => {
        const exists = allUsers.find(u => u.email.toLowerCase() === email.toLowerCase());
        
        if (exists) {
          selectEmail(exists);
        } else {
          const newId = 'MX' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
          setFormData({
            nombreCompleto: '',
            nickname: '',
            id: newId,
            telefono: '',
            nombreContactoEmergencia: '',
            telefonoEmergencia: '',
            direccionEmergencia: '',
            tipoSangre: '',
            alergias: '',
            observaciones: ''
          });
          setIsExistingUser(false);
          setShowForm(true);
        }
      };

      const formatPhone = (value) => {
        const numbers = value.replace(/\D/g, '');
        if (numbers.length <= 2) return numbers;
        if (numbers.length <= 6) return `${numbers.slice(0, 2)}-${numbers.slice(2)}`;
        return `${numbers.slice(0, 2)}-${numbers.slice(2, 6)}-${numbers.slice(6, 10)}`;
      };

      const handlePhoneChange = (field, value) => {
        const formatted = formatPhone(value);
        setFormData({ ...formData, [field]: formatted });
      };

      const handleSubmit = async () => {
        setLoading(true);
        
        try {
          const dataToSave = {
            email: email,
            nombreCompleto: formData.nombreCompleto,
            nickname: formData.nickname,
            id: formData.id,
            telefono: formData.telefono,
            nombreContactoEmergencia: formData.nombreContactoEmergencia,
            telefonoEmergencia: formData.telefonoEmergencia,
            direccionEmergencia: formData.direccionEmergencia,
            tipoSangre: formData.tipoSangre,
            alergias: formData.alergias,
            observaciones: formData.observaciones
          };

          const response = await fetch(APPS_SCRIPT_URL, {
            method: 'POST',
            mode: 'no-cors',
            headers: {
              'Content-Type': 'application/json',
            },
            body: JSON.stringify(dataToSave)
          });

          // Con mode: 'no-cors' no podemos leer la respuesta, pero asumimos √©xito
          alert(`‚úÖ Registro ${isExistingUser ? 'actualizado' : 'creado'} exitosamente!\n\nüìß Email: ${email}\nID: ${formData.id}\n\n‚úâÔ∏è Se ha simulado el env√≠o del correo electr√≥nico con los datos del registro y el c√≥digo QR.\n\nEn producci√≥n, aqu√≠ se enviar√≠a el email autom√°ticamente.`);
          
          setLoading(false);
          onBack();
        } catch (error) {
          console.error('Error:', error);
          alert('‚ùå Error al guardar. Verifica tu conexi√≥n e intenta de nuevo.');
          setLoading(false);
        }
      };

      if (!showForm) {
        return (
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6">
            <div className="max-w-lg mx-auto">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">Buscar por Email</h2>
                
                <input
                  type="email"
                  value={email}
                  onChange={(e) => handleEmailChange(e.target.value)}
                  placeholder="Ingresa tu email"
                  className="w-full p-3 border-2 border-gray-300 rounded-lg mb-2 focus:border-blue-500 focus:outline-none"
                />

                {suggestions.length > 0 && (
                  <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto mb-4">
                    {suggestions.map((user, idx) => (
                      <div
                        key={idx}
                        onClick={() => selectEmail(user)}
                        className="p-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0"
                      >
                        <p className="font-semibold text-gray-800">{user.email}</p>
                        <p className="text-sm text-gray-600">{user.nombreCompleto}</p>
                      </div>
                    ))}
                  </div>
                )}

                <button
                  onClick={handleContinue}
                  disabled={!email}
                  className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
                >
                  Continuar
                </button>

                <button
                  onClick={onBack}
                  className="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        );
      }

      return (
        <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6 overflow-y-auto">
          <div className="max-w-2xl mx-auto">
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-bold mb-4 text-gray-800">
                {isExistingUser ? 'Actualizar Datos' : 'Nuevo Registro'}
              </h2>
              
              <div className="space-y-4">
                <div>
                  <label className="block text-sm font-semibold mb-1">Email</label>
                  <input
                    type="email"
                    value={email}
                    disabled
                    className="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">ID</label>
                  <input
                    type="text"
                    value={formData.id}
                    disabled
                    className="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Nombre Completo *</label>
                  <input
                    type="text"
                    value={formData.nombreCompleto}
                    onChange={(e) => setFormData({ ...formData, nombreCompleto: e.target.value })}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Nickname *</label>
                  <input
                    type="text"
                    value={formData.nickname}
                    onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Tel√©fono (xx-xxxx-xxxx) *</label>
                  <input
                    type="text"
                    value={formData.telefono}
                    onChange={(e) => handlePhoneChange('telefono', e.target.value)}
                    maxLength={12}
                    placeholder="55-1234-5678"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Nombre Contacto Emergencia *</label>
                  <input
                    type="text"
                    value={formData.nombreContactoEmergencia}
                    onChange={(e) => setFormData({ ...formData, nombreContactoEmergencia: e.target.value })}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Tel√©fono Emergencia (xx-xxxx-xxxx) *</label>
                  <input
                    type="text"
                    value={formData.telefonoEmergencia}
                    onChange={(e) => handlePhoneChange('telefonoEmergencia', e.target.value)}
                    maxLength={12}
                    placeholder="55-1234-5678"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Direcci√≥n Emergencia</label>
                  <textarea
                    value={formData.direccionEmergencia}
                    onChange={(e) => setFormData({ ...formData, direccionEmergencia: e.target.value })}
                    rows="3"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Tipo de Sangre *</label>
                  <select
                    value={formData.tipoSangre}
                    onChange={(e) => setFormData({ ...formData, tipoSangre: e.target.value })}
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  >
                    <option value="">Selecciona...</option>
                    <option value="A+">A+</option>
                    <option value="A-">A-</option>
                    <option value="B+">B+</option>
                    <option value="B-">B-</option>
                    <option value="AB+">AB+</option>
                    <option value="AB-">AB-</option>
                    <option value="O+">O+</option>
                    <option value="O-">O-</option>
                  </select>
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Alergias</label>
                  <textarea
                    value={formData.alergias}
                    onChange={(e) => setFormData({ ...formData, alergias: e.target.value })}
                    rows="3"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div>
                  <label className="block text-sm font-semibold mb-1">Observaciones</label>
                  <textarea
                    value={formData.observaciones}
                    onChange={(e) => setFormData({ ...formData, observaciones: e.target.value })}
                    rows="3"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                  />
                </div>

                <div className="flex gap-3 pt-4">
                  <button
                    onClick={handleSubmit}
                    disabled={loading || !formData.nombreCompleto || !formData.nickname || !formData.telefono || !formData.tipoSangre}
                    className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    {loading ? 'Guardando...' : 'OK'}
                  </button>
                  
                  <button
                    onClick={onBack}
                    disabled={loading}
                    className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    };

    const GallxsApp = () => {
      const [currentScreen, setCurrentScreen] = useState('home');

      const renderHome = () => (
        <div className="flex-1 flex flex-col">
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6 flex flex-col justify-center gap-6">
            <button
              onClick={() => alert('Funcionalidad de Check-In pr√≥ximamente')}
              className="pulse-green bg-green-500 hover:bg-green-600 text-white rounded-2xl p-8 shadow-2xl transform transition hover:scale-105 active:scale-95"
            >
              <div className="flex flex-col items-center gap-3">
                <BikeIcon />
                <span className="text-2xl font-bold">Check-In Rodada</span>
                <span className="text-sm opacity-90">Registra tu asistencia</span>
              </div>
            </button>

            <div className="grid grid-cols-2 gap-4">
              <button
                onClick={() => setCurrentScreen('register')}
                className="bg-blue-500 hover:bg-blue-600 text-white rounded-xl p-6 shadow-xl transform transition hover:scale-105 active:scale-95"
              >
                <div className="flex flex-col items-center gap-2">
                  <UserPlusIcon />
                  <span className="text-lg font-bold">Registrar</span>
                </div>
              </button>

              <button
                onClick={() => alert('Funcionalidad de Enviar C√≥digo QR pr√≥ximamente')}
                className="bg-purple-500 hover:bg-purple-600 text-white rounded-xl p-6 shadow-xl transform transition hover:scale-105 active:scale-95"
              >
                <div className="flex flex-col items-center gap-2">
                  <QrCodeIcon />
                  <span className="text-lg font-bold">Enviar C√≥digo QR</span>
                </div>
              </button>
            </div>

            <button
              onClick={() => alert('Funcionalidad SOS pr√≥ximamente')}
              className="pulse-red bg-red-500 hover:bg-red-600 text-white rounded-2xl p-8 shadow-2xl transform transition hover:scale-105 active:scale-95"
            >
              <div className="flex flex-col items-center gap-3">
                <AlertIcon />
                <span className="text-2xl font-bold">SOS</span>
                <span className="text-sm opacity-90">Emergencia</span>
              </div>
            </button>
          </div>
        </div>
      );

      const renderSettings = () => (
        <div className="flex-1 flex flex-col">
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6">
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">Ajustes</h2>
              <p className="text-gray-600">Configuraci√≥n pr√≥ximamente disponible</p>
            </div>
          </div>
        </div>
      );

      const getSubtitle = () => {
        if (currentScreen === 'register') return 'Mobile App - Registrar';
        if (currentScreen === 'settings') return 'Mobile App - Configuraci√≥n';
        return 'Mobile App';
      };

      return (
        <div className="min-h-screen flex flex-col bg-white">
          <div className="bg-white text-black py-6 px-4 text-center border-b-2 border-gray-200">
            <h1 className="text-2xl font-bold">GALLXS - CYCLING CLUB</h1>
            <p className="text-sm font-bold text-gray-700">{getSubtitle()}</p>
          </div>

          {currentScreen === 'home' && renderHome()}
          {currentScreen === 'register' && <RegisterScreen onBack={() => setCurrentScreen('home')} />}
          {currentScreen === 'settings' && renderSettings()}

          <div className="bg-white border-t-2 border-gray-200 shadow-lg">
            <div className="flex justify-around items-center py-4">
              <button
                onClick={() => setCurrentScreen('home')}
                className={`flex flex-col items-center gap-1 px-6 py-2 rounded-lg transition ${
                  currentScreen === 'home'
                    ? 'text-green-600 bg-green-50'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <HomeIcon />
                <span className="text-xs font-semibold">Home</span>
              </button>

              <button
                onClick={() => setCurrentScreen('settings')}
                className={`flex flex-col items-center gap-1 px-6 py-2 rounded-lg transition ${
                  currentScreen === 'settings'
                    ? 'text-green-600 bg-green-50'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <SettingsIcon />
                <span className="text-xs font-semibold">Configuraci√≥n</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<GallxsApp />, document.getElementById('root'));
  </script>
</body>
</html>
