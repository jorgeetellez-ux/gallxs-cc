<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Gallxs CC - Aplicaci√≥n m√≥vil para el equipo de entrenamiento">
  <meta name="theme-color" content="#FF9800">
  <title>Gallxs CC - Mobile App</title>
  
  <!-- PWA Manifest -->
  <link rel="manifest" href="data:application/json;base64,ewogICJuYW1lIjogIkdhbGx4cyBDQyAtIE1vYmlsZSBBcHAiLAogICJzaG9ydF9uYW1lIjogIkdhbGx4cyBDQyIsCiAgImRlc2NyaXB0aW9uIjogIkFwbGljYWNpw7NuIG3Ds3ZpbCBwYXJhIGVsIGVxdWlwbyBkZSBlbnRyZW5hbWllbnRvIEdhbGx4cyIsCiAgInN0YXJ0X3VybCI6ICIuLyIsCiAgImRpc3BsYXkiOiAic3RhbmRhbG9uZSIsCiAgImJhY2tncm91bmRfY29sb3IiOiAiI2ZmZmZmZiIsCiAgInRoZW1lX2NvbG9yIjogIiNGRjk4MDAiLAogICJpY29ucyI6IFsKICAgIHsKICAgICAgInNyYyI6ICJkYXRhOmltYWdlL3N2Zyt4bWwsJTNDc3ZnJTIweG1sbnM9J2h0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnJyUyMHdpZHRoPScxOTInJTIwaGVpZ2h0PScxOTInJTNFJTNDcmVjdCUyMHdpZHRoPScxOTInJTIwaGVpZ2h0PScxOTInJTIwZmlsbD0nJTIzRkY5ODAwJy8lM0UlM0N0ZXh0JTIweD0nOTYnJTIweT0nMTIwJyUyMGZvbnQtc2l6ZT0nODAnJTIwdGV4dC1hbmNob3I9J21pZGRsZSclMjBmaWxsPSclMjNmZmZmZmYnJTIwZm9udC13ZWlnaHQ9J2JvbGQnJTIwZm9udC1mYW1pbHk9J0FyaWFsJTJDc2Fucy1zZXJpZiclM0VHWCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICIxOTJ4MTkyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0sCiAgICB7CiAgICAgICJzcmMiOiAiZGF0YTppbWFnZS9zdmcreG1sLCUzQ3N2ZyUyMHhtbG5zPSdodHRwOi8vd3d3LnczLm9yZy8yMDAwL3N2ZyclMjB3aWR0aD0nNTEyJyUyMGhlaWdodD0nNTEyJyUzRSUzQ3JlY3QlMjB3aWR0aD0nNTEyJyUyMGhlaWdodD0nNTEyJyUyMGZpbGw9JyUyM0ZGOTgwMCcvJTNFJTNDdGV4dCUyMHg9JzI1NiclMjB5PSczMjAnJTIwZm9udC1zaXplPSclMjAyMTAnJTIwdGV4dC1hbmNob3I9J21pZGRsZSclMjBmaWxsPSclMjNmZmZmZmYnJTIwZm9udC13ZWlnaHQ9J2JvbGQnJTIwZm9udC1mYW1pbHk9J0FyaWFsJTJDc2Fucy1zZXJpZiclM0VHWCUzQy90ZXh0JTNFJTNDL3N2ZyUzRSIsCiAgICAgICJzaXplcyI6ICI1MTJ4NTEyIiwKICAgICAgInR5cGUiOiAiaW1hZ2Uvc3ZnK3htbCIKICAgIH0KICBdCn0=">
  
  <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://unpkg.com/jsqr@1.4.0/dist/jsQR.js"></script>
  
  <style>
    body { 
      margin: 0; 
      padding: 0; 
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      overflow-x: hidden;
    }
    
    @keyframes pulse-green {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(34, 197, 94, 0.7);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(34, 197, 94, 0);
      }
    }
    
    @keyframes pulse-red {
      0%, 100% {
        box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
      }
      50% {
        box-shadow: 0 0 0 15px rgba(239, 68, 68, 0);
      }
    }
    
    .pulse-green {
      animation: pulse-green 2s infinite;
    }
    
    .pulse-red {
      animation: pulse-red 2s infinite;
    }
  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState, useEffect, useRef } = React;

    const SHEET_ID = '1qs4urivhp8Huv1BasaMNHjZwe43-C2P_sDfwzXKYQMw';
    const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json`;
    const RUTAS_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?gid=2141318151&tqx=out:json`;
    const APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbx6vRyOD6a3Fx2vTHMTDVqfqmCFLJb129vj3xoPtxJct7upsGID0Om0-1c0Anm_b4ed/exec';

    // Iconos SVG
    const HomeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M3 9l9-7 9 7v11a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
        <polyline points="9 22 9 12 15 12 15 22"></polyline>
      </svg>
    );

    const SettingsIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="12" cy="12" r="3"></circle>
        <path d="M12 1v6m0 6v6m5.2-13.2l-4.2 4.2m-1 1l-4.2 4.2m12.4-1.2l-4.2-4.2m-1-1l-4.2-4.2"></path>
      </svg>
    );

    const UserPlusIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M16 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"></path>
        <circle cx="8.5" cy="7" r="4"></circle>
        <line x1="20" y1="8" x2="20" y2="14"></line>
        <line x1="23" y1="11" x2="17" y2="11"></line>
      </svg>
    );

    const QrCodeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <rect x="3" y="3" width="7" height="7"></rect>
        <rect x="14" y="3" width="7" height="7"></rect>
        <rect x="14" y="14" width="7" height="7"></rect>
        <rect x="3" y="14" width="7" height="7"></rect>
      </svg>
    );

    const BikeIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="18.5" cy="17.5" r="3.5"></circle>
        <circle cx="5.5" cy="17.5" r="3.5"></circle>
        <circle cx="15" cy="5" r="1"></circle>
        <path d="M12 17.5V14l-3-3 4-3 2 3h2"></path>
      </svg>
    );

    const AlertIcon = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"></path>
        <line x1="12" y1="9" x2="12" y2="13"></line>
        <line x1="12" y1="17" x2="12.01" y2="17"></line>
      </svg>
    );

    const Camera = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"></path>
        <circle cx="12" cy="13" r="4"></circle>
      </svg>
    );

    const Search = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <circle cx="11" cy="11" r="8"></circle>
        <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
      </svg>
    );

    const MapPin = () => (
      <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" strokeLinecap="round" strokeLinejoin="round">
        <path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0 1 18 0z"></path>
        <circle cx="12" cy="10" r="3"></circle>
      </svg>
    );

    const GallxsApp = () => {
      const [currentScreen, setCurrentScreen] = useState('home');

      // Componente de Registro
      const RegisterScreen = ({ onBack }) => {
        const [email, setEmail] = useState('');
        const [suggestions, setSuggestions] = useState([]);
        const [allUsers, setAllUsers] = useState([]);
        const [formData, setFormData] = useState({
          nombreCompleto: '',
          nickname: '',
          id: '',
          telefono: '',
          nombreContactoEmergencia: '',
          telefonoEmergencia: '',
          direccionEmergencia: '',
          tipoSangre: '',
          alergias: '',
          observaciones: ''
        });
        const [isExistingUser, setIsExistingUser] = useState(false);
        const [loading, setLoading] = useState(false);
        const [showForm, setShowForm] = useState(false);

        useEffect(() => {
          loadUsers();
        }, []);

        const loadUsers = async () => {
          try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
            if (!jsonString) return;
            
            const json = JSON.parse(jsonString[1]);
            const rows = json.table.rows;
            
            const users = rows.map(row => ({
              email: row.c[0]?.v || '',
              nombreCompleto: row.c[1]?.v || '',
              nickname: row.c[2]?.v || '',
              id: row.c[3]?.v || '',
              telefono: row.c[4]?.v || '',
              nombreContactoEmergencia: row.c[5]?.v || '',
              telefonoEmergencia: row.c[6]?.v || '',
              direccionEmergencia: row.c[7]?.v || '',
              tipoSangre: row.c[8]?.v || '',
              alergias: row.c[9]?.v || '',
              observaciones: row.c[10]?.v || ''
            })).filter(u => u.email);
            
            setAllUsers(users);
          } catch (error) {
            console.error('Error loading users:', error);
          }
        };

        const handleEmailChange = (value) => {
          setEmail(value);
          
          if (value.length > 2) {
            const filtered = allUsers.filter(user => 
              user.email.toLowerCase().includes(value.toLowerCase())
            );
            setSuggestions(filtered);
          } else {
            setSuggestions([]);
          }
        };

        const selectEmail = (user) => {
          setEmail(user.email);
          setFormData({
            nombreCompleto: user.nombreCompleto,
            nickname: user.nickname,
            id: user.id,
            telefono: user.telefono,
            nombreContactoEmergencia: user.nombreContactoEmergencia,
            telefonoEmergencia: user.telefonoEmergencia,
            direccionEmergencia: user.direccionEmergencia,
            tipoSangre: user.tipoSangre,
            alergias: user.alergias,
            observaciones: user.observaciones
          });
          setIsExistingUser(true);
          setShowForm(true);
          setSuggestions([]);
        };

        const handleContinue = () => {
          const exists = allUsers.find(u => u.email.toLowerCase() === email.toLowerCase());
          
          if (exists) {
            selectEmail(exists);
          } else {
            let newId;
            let idExists = true;
            
            while (idExists) {
              newId = 'MX' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
              idExists = allUsers.some(u => u.id === newId);
            }
            
            setFormData({
              nombreCompleto: '',
              nickname: '',
              id: newId,
              telefono: '',
              nombreContactoEmergencia: '',
              telefonoEmergencia: '',
              direccionEmergencia: '',
              tipoSangre: '',
              alergias: '',
              observaciones: ''
            });
            setIsExistingUser(false);
            setShowForm(true);
          }
        };

        const formatPhone = (value) => {
          const numbers = value.replace(/\D/g, '');
          if (numbers.length <= 2) return numbers;
          if (numbers.length <= 6) return `${numbers.slice(0, 2)}-${numbers.slice(2)}`;
          return `${numbers.slice(0, 2)}-${numbers.slice(2, 6)}-${numbers.slice(6, 10)}`;
        };

        const handlePhoneChange = (field, value) => {
          const formatted = formatPhone(value);
          setFormData({ ...formData, [field]: formatted });
        };

        const handleSubmit = async () => {
          setLoading(true);
          
          try {
            const dataToSave = {
              email: email,
              nombreCompleto: formData.nombreCompleto,
              nickname: formData.nickname,
              id: formData.id,
              telefono: formData.telefono,
              nombreContactoEmergencia: formData.nombreContactoEmergencia,
              telefonoEmergencia: formData.telefonoEmergencia,
              direccionEmergencia: formData.direccionEmergencia,
              tipoSangre: formData.tipoSangre,
              alergias: formData.alergias,
              observaciones: formData.observaciones
            };

            const formData2 = new FormData();
            formData2.append('data', JSON.stringify(dataToSave));

            const response = await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              body: formData2
            });

            const result = await response.json();
            
            if (result.success) {
              alert(`‚úÖ ${result.message}!\n\nüìß Email: ${email}\nID: ${formData.id}`);
              setLoading(false);
              onBack();
            } else {
              throw new Error(result.error || 'Error desconocido');
            }
          } catch (error) {
            console.error('Error completo:', error);
            alert('‚ùå Error al guardar: ' + error.message);
            setLoading(false);
          }
        };

        const handleDelete = async () => {
          if (isExistingUser) {
            const confirmDelete = confirm(`¬øEst√°s seguro de eliminar el registro de ${formData.nombreCompleto}?\n\nEsta acci√≥n no se puede deshacer.`);
            
            if (!confirmDelete) return;
            
            setLoading(true);
            
            try {
              const deleteData = {
                action: 'delete',
                email: email
              };

              const formData2 = new FormData();
              formData2.append('data', JSON.stringify(deleteData));

              const response = await fetch(APPS_SCRIPT_URL, {
                method: 'POST',
                body: formData2
              });

              const result = await response.json();
              
              if (result.success) {
                alert('‚úÖ Registro eliminado exitosamente de Google Sheets.');
                setLoading(false);
                onBack();
              } else {
                throw new Error(result.error || 'Error al eliminar');
              }
            } catch (error) {
              console.error('Error:', error);
              alert('‚ùå Error al eliminar: ' + error.message);
              setLoading(false);
            }
          } else {
            const confirmClear = confirm('¬øEst√°s seguro de limpiar todos los campos del formulario?');
            
            if (!confirmClear) return;
            
            let newId;
            let idExists = true;
            
            while (idExists) {
              newId = 'MX' + Math.floor(Math.random() * 1000000).toString().padStart(6, '0');
              idExists = allUsers.some(u => u.id === newId);
            }
            
            setFormData({
              nombreCompleto: '',
              nickname: '',
              id: newId,
              telefono: '',
              nombreContactoEmergencia: '',
              telefonoEmergencia: '',
              direccionEmergencia: '',
              tipoSangre: '',
              alergias: '',
              observaciones: ''
            });
          }
        };

        if (!showForm) {
          return (
            <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6">
              <div className="max-w-lg mx-auto">
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4 text-gray-800">Buscar por Email</h2>
                  
                  <input
                    type="email"
                    value={email}
                    onChange={(e) => handleEmailChange(e.target.value)}
                    placeholder="Ingresa tu email"
                    className="w-full p-3 border-2 border-gray-300 rounded-lg mb-2 focus:border-blue-500 focus:outline-none"
                  />

                  {suggestions.length > 0 && (
                    <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto mb-4">
                      {suggestions.map((user, idx) => (
                        <div
                          key={idx}
                          onClick={() => selectEmail(user)}
                          className="p-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0"
                        >
                          <p className="font-semibold text-gray-800">{user.email}</p>
                          <p className="text-sm text-gray-600">{user.nombreCompleto}</p>
                        </div>
                      ))}
                    </div>
                  )}

                  <button
                    onClick={handleContinue}
                    disabled={!email}
                    className="w-full bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
                  >
                    Continuar
                  </button>

                  <button
                    onClick={onBack}
                    className="w-full mt-3 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold"
                  >
                    Cancelar
                  </button>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6 overflow-y-auto">
            <div className="max-w-2xl mx-auto">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">
                  {isExistingUser ? 'Actualizar Datos' : 'Nuevo Registro'}
                </h2>
                
                <div className="space-y-4">
                  <div>
                    <label className="block text-sm font-semibold mb-1">Email</label>
                    <input
                      type="email"
                      value={email}
                      disabled
                      className="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">ID</label>
                    <input
                      type="text"
                      value={formData.id}
                      disabled
                      className="w-full p-3 border-2 border-gray-200 rounded-lg bg-gray-100"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Nombre Completo *</label>
                    <input
                      type="text"
                      value={formData.nombreCompleto}
                      onChange={(e) => setFormData({ ...formData, nombreCompleto: e.target.value })}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Nickname *</label>
                    <input
                      type="text"
                      value={formData.nickname}
                      onChange={(e) => setFormData({ ...formData, nickname: e.target.value })}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Tel√©fono (xx-xxxx-xxxx) *</label>
                    <input
                      type="text"
                      value={formData.telefono}
                      onChange={(e) => handlePhoneChange('telefono', e.target.value)}
                      maxLength={12}
                      placeholder="55-1234-5678"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Nombre Contacto Emergencia *</label>
                    <input
                      type="text"
                      value={formData.nombreContactoEmergencia}
                      onChange={(e) => setFormData({ ...formData, nombreContactoEmergencia: e.target.value })}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Tel√©fono Emergencia (xx-xxxx-xxxx) *</label>
                    <input
                      type="text"
                      value={formData.telefonoEmergencia}
                      onChange={(e) => handlePhoneChange('telefonoEmergencia', e.target.value)}
                      maxLength={12}
                      placeholder="55-1234-5678"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Direcci√≥n Emergencia</label>
                    <textarea
                      value={formData.direccionEmergencia}
                      onChange={(e) => setFormData({ ...formData, direccionEmergencia: e.target.value })}
                      rows="3"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Tipo de Sangre *</label>
                    <select
                      value={formData.tipoSangre}
                      onChange={(e) => setFormData({ ...formData, tipoSangre: e.target.value })}
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    >
                      <option value="">Selecciona...</option>
                      <option value="A +">A +</option>
                      <option value="A -">A -</option>
                      <option value="B +">B +</option>
                      <option value="B -">B -</option>
                      <option value="AB +">AB +</option>
                      <option value="AB -">AB -</option>
                      <option value="O +">O +</option>
                      <option value="O -">O -</option>
                      <option value="LO DESCONOZCO">LO DESCONOZCO</option>
                    </select>
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Alergias</label>
                    <textarea
                      value={formData.alergias}
                      onChange={(e) => setFormData({ ...formData, alergias: e.target.value })}
                      rows="3"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div>
                    <label className="block text-sm font-semibold mb-1">Observaciones</label>
                    <textarea
                      value={formData.observaciones}
                      onChange={(e) => setFormData({ ...formData, observaciones: e.target.value })}
                      rows="3"
                      className="w-full p-3 border-2 border-gray-300 rounded-lg focus:border-blue-500 focus:outline-none"
                    />
                  </div>

                  <div className="flex gap-3 pt-4">
                    <button
                      onClick={handleSubmit}
                      disabled={loading || !formData.nombreCompleto || !formData.nickname || !formData.telefono || !formData.tipoSangre}
                      className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      {loading ? 'Guardando...' : 'OK'}
                    </button>
                    
                    <button
                      onClick={handleDelete}
                      disabled={loading}
                      className="flex-1 bg-orange-500 hover:bg-orange-600 text-white py-3 rounded-lg font-semibold"
                    >
                      {isExistingUser ? 'Eliminar' : 'Limpiar'}
                    </button>
                    
                    <button
                      onClick={onBack}
                      disabled={loading}
                      className="flex-1 bg-red-500 hover:bg-red-600 text-white py-3 rounded-lg font-semibold"
                    >
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        );
      };

      // Componente de Generar QR
      const QRCodeScreen = ({ onBack }) => {
        const [searchTerm, setSearchTerm] = useState('');
        const [suggestions, setSuggestions] = useState([]);
        const [allUsers, setAllUsers] = useState([]);
        const [selectedUser, setSelectedUser] = useState(null);
        const [loading, setLoading] = useState(false);
        const qrRef = useRef(null);

        useEffect(() => {
          loadUsers();
        }, []);

        const loadUsers = async () => {
          setLoading(true);
          try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
            if (!jsonString) return;
            
            const json = JSON.parse(jsonString[1]);
            const rows = json.table.rows;
            
            const users = rows.map(row => ({
              email: row.c[0]?.v || '',
              nombreCompleto: row.c[1]?.v || '',
              nickname: row.c[2]?.v || '',
              id: row.c[3]?.v || '',
              telefono: row.c[4]?.v || '',
              nombreContactoEmergencia: row.c[5]?.v || '',
              telefonoEmergencia: row.c[6]?.v || '',
              direccionEmergencia: row.c[7]?.v || '',
              tipoSangre: row.c[8]?.v || '',
              alergias: row.c[9]?.v || '',
              observaciones: row.c[10]?.v || ''
            })).filter(u => u.email);
            
            setAllUsers(users);
          } catch (error) {
            console.error('Error loading users:', error);
          } finally {
            setLoading(false);
          }
        };

        const handleSearchChange = (value) => {
          setSearchTerm(value);
          
          if (value.length > 1) {
            const filtered = allUsers.filter(user => 
              user.email.toLowerCase().includes(value.toLowerCase()) ||
              user.nombreCompleto.toLowerCase().includes(value.toLowerCase()) ||
              user.nickname.toLowerCase().includes(value.toLowerCase()) ||
              user.id.toLowerCase().includes(value.toLowerCase())
            );
            setSuggestions(filtered);
          } else {
            setSuggestions([]);
          }
        };

        const selectUser = (user) => {
          setSelectedUser(user);
          setSearchTerm('');
          setSuggestions([]);
          
          setTimeout(() => {
            generateQR(user.id);
          }, 100);
        };

        const generateQR = (id) => {
          if (qrRef.current) {
            qrRef.current.innerHTML = '';
            new QRCode(qrRef.current, {
              text: id,
              width: 200,
              height: 200,
              colorDark: "#000000",
              colorLight: "#ffffff",
              correctLevel: QRCode.CorrectLevel.H
            });
          }
        };

        const resetSearch = () => {
          setSelectedUser(null);
          setSearchTerm('');
          setSuggestions([]);
        };

        if (selectedUser) {
          return (
            <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6 overflow-y-auto">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-lg overflow-hidden">
                  <div className="bg-purple-600 text-white p-6">
                    <div className="flex items-center justify-center gap-3">
                      <QrCodeIcon />
                      <h2 className="text-2xl font-bold">C√≥digo QR Generado</h2>
                    </div>
                  </div>

                  <div className="p-6 space-y-6">
                    <div className="flex justify-center bg-gray-50 p-6 rounded-lg">
                      <div ref={qrRef}></div>
                    </div>

                    <div className="border-t pt-4">
                      <h3 className="text-xl font-bold text-gray-900 mb-4">Informaci√≥n del Ciclista</h3>
                      
                      <div className="grid gap-4">
                        <div className="bg-blue-50 p-4 rounded-lg">
                          <p className="text-sm font-semibold text-gray-600">ID</p>
                          <p className="text-lg font-bold text-gray-900">{selectedUser.id}</p>
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg">
                          <p className="text-sm font-semibold text-gray-600">Nombre Completo</p>
                          <p className="text-lg font-bold text-gray-900">{selectedUser.nombreCompleto}</p>
                        </div>

                        <div className="bg-gray-50 p-4 rounded-lg">
                          <p className="text-sm font-semibold text-gray-600">Nickname</p>
                          <p className="text-lg text-gray-900">{selectedUser.nickname}</p>
                        </div>

                        <div className="grid grid-cols-2 gap-4">
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <p className="text-sm font-semibold text-gray-600">Email</p>
                            <p className="text-sm text-gray-900 break-all">{selectedUser.email}</p>
                          </div>

                          <div className="bg-gray-50 p-4 rounded-lg">
                            <p className="text-sm font-semibold text-gray-600">Tel√©fono</p>
                            <p className="text-sm text-gray-900">{selectedUser.telefono}</p>
                          </div>
                        </div>

                        {selectedUser.tipoSangre && (
                          <div className="bg-red-50 p-4 rounded-lg border-2 border-red-200">
                            <p className="text-sm font-semibold text-gray-600">Tipo de Sangre</p>
                            <p className="text-2xl font-bold text-red-600">{selectedUser.tipoSangre}</p>
                          </div>
                        )}

                        <div className="border-t-2 border-purple-200 pt-4 mt-2">
                          <h4 className="text-lg font-bold text-purple-700 mb-3">Contacto de Emergencia</h4>
                          <div className="bg-purple-50 p-4 rounded-lg space-y-2">
                            <div>
                              <p className="text-sm font-semibold text-gray-600">Nombre</p>
                              <p className="text-gray-900">{selectedUser.nombreContactoEmergencia}</p>
                            </div>
                            <div>
                              <p className="text-sm font-semibold text-gray-600">Tel√©fono</p>
                              <p className="text-lg font-bold text-purple-700">{selectedUser.telefonoEmergencia}</p>
                            </div>
                            {selectedUser.direccionEmergencia && (
                              <div>
                                <p className="text-sm font-semibold text-gray-600">Direcci√≥n</p>
                                <p className="text-gray-900">{selectedUser.direccionEmergencia}</p>
                              </div>
                            )}
                          </div>
                        </div>

                        {selectedUser.alergias && (
                          <div className="bg-yellow-50 p-4 rounded-lg border-2 border-yellow-200">
                            <p className="text-sm font-semibold text-gray-600">Alergias</p>
                            <p className="text-gray-900">{selectedUser.alergias}</p>
                          </div>
                        )}

                        {selectedUser.observaciones && (
                          <div className="bg-gray-50 p-4 rounded-lg">
                            <p className="text-sm font-semibold text-gray-600">Observaciones</p>
                            <p className="text-gray-900">{selectedUser.observaciones}</p>
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="flex gap-3 pt-4">
                      <button
                        onClick={resetSearch}
                        className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold"
                      >
                        Buscar Otro
                      </button>
                      
                      <button
                        onClick={onBack}
                        className="flex-1 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold"
                      >
                        Cancelar
                      </button>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6">
            <div className="max-w-lg mx-auto">
              <div className="bg-white rounded-xl shadow-lg p-6">
                <h2 className="text-xl font-bold mb-4 text-gray-800">Buscar Ciclista</h2>
                <p className="text-sm text-gray-600 mb-4">Busca por nombre, nickname, email o ID</p>
                
                {loading ? (
                  <div className="text-center py-8">
                    <div className="animate-spin rounded-full h-12 w-12 border-b-4 border-purple-600 mx-auto"></div>
                    <p className="text-gray-600 mt-4">Cargando datos...</p>
                  </div>
                ) : (
                  <>
                    <input
                      type="text"
                      value={searchTerm}
                      onChange={(e) => handleSearchChange(e.target.value)}
                      placeholder="Escribe para buscar..."
                      className="w-full p-3 border-2 border-gray-300 rounded-lg mb-2 focus:border-purple-500 focus:outline-none"
                    />

                    {suggestions.length > 0 && (
                      <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-96 overflow-y-auto">
                        {suggestions.map((user, idx) => (
                          <div
                            key={idx}
                            onClick={() => selectUser(user)}
                            className="p-4 hover:bg-purple-50 cursor-pointer border-b last:border-b-0"
                          >
                            <p className="font-bold text-gray-900">{user.nombreCompleto}</p>
                            <p className="text-sm text-gray-600">@{user.nickname}</p>
                            <p className="text-xs text-gray-500">{user.email} ‚Ä¢ ID: {user.id}</p>
                          </div>
                        ))}
                      </div>
                    )}

                    {searchTerm && suggestions.length === 0 && (
                      <div className="text-center py-8 text-gray-500">
                        No se encontraron resultados
                      </div>
                    )}
                  </>
                )}

                <button
                  onClick={onBack}
                  className="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold"
                >
                  Cancelar
                </button>
              </div>
            </div>
          </div>
        );
      };

      // Componente SOS con Esc√°ner QR
      const SOSScreen = ({ onBack }) => {
        const [scanning, setScanning] = useState(true);
        const [personData, setPersonData] = useState(null);
        const [error, setError] = useState('');
        const [loading, setLoading] = useState(false);
        const videoRef = useRef(null);
        const canvasRef = useRef(null);
        const streamRef = useRef(null);
        const scanIntervalRef = useRef(null);

        useEffect(() => {
          startCamera();
          return () => {
            stopCamera();
          };
        }, []);

        const startCamera = async () => {
          try {
            setError('');
            setScanning(true);
            
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            });
            
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              streamRef.current = stream;
              
              videoRef.current.setAttribute('playsinline', 'true');
              videoRef.current.setAttribute('autoplay', 'true');
              
              videoRef.current.onloadedmetadata = async () => {
                try {
                  await videoRef.current.play();
                  startScanning();
                } catch (playErr) {
                  console.error('Error playing video:', playErr);
                  setError('Error al iniciar el video. Intenta de nuevo.');
                  stopCamera();
                }
              };
            }
          } catch (err) {
            setError('No se pudo acceder a la c√°mara. Verifica los permisos.');
            console.error(err);
            setScanning(false);
          }
        };

        const stopCamera = () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
          }
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
            scanIntervalRef.current = null;
          }
          setScanning(false);
        };

        const startScanning = () => {
          if (typeof jsQR === 'undefined') {
            setError('La librer√≠a de escaneo no se carg√≥ correctamente. Recarga la p√°gina.');
            stopCamera();
            return;
          }
          
          scanIntervalRef.current = setInterval(() => {
            scanQRCode();
          }, 300);
        };

        const scanQRCode = () => {
          if (!videoRef.current || !canvasRef.current) return;
          
          if (typeof jsQR === 'undefined') {
            console.error('jsQR no est√° cargado');
            return;
          }

          const video = videoRef.current;
          const canvas = canvasRef.current;
          const context = canvas.getContext('2d');

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const width = video.videoWidth;
            const height = video.videoHeight;
            
            if (width > 0 && height > 0) {
              canvas.width = width;
              canvas.height = height;
              context.drawImage(video, 0, 0, width, height);

              const imageData = context.getImageData(0, 0, width, height);
              
              try {
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: "attemptBoth",
                });

                if (code && code.data) {
                  console.log('QR detectado:', code.data);
                  stopCamera();
                  handleQRScanned(code.data);
                }
              } catch (err) {
                console.error('Error al escanear:', err);
              }
            }
          }
        };

        const handleQRScanned = async (qrData) => {
          setLoading(true);
          setError('');
          
          try {
            const id = qrData.trim();
            
            const response = await fetch(SHEET_URL);
            
            if (!response.ok) {
              throw new Error('No se pudo acceder a la hoja. Verifica que sea p√∫blica.');
            }
            
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
            if (!jsonString) {
              throw new Error('Formato de respuesta inv√°lido');
            }
            
            const json = JSON.parse(jsonString[1]);
            
            if (json.status === 'error') {
              throw new Error(json.errors[0].detailed_message || 'Error en la consulta');
            }
            
            const rows = json.table.rows;
            
            let foundPerson = null;
            for (let i = 0; i < rows.length; i++) {
              const row = rows[i].c;
              if (!row) continue;
              
              const personId = row[3]?.v || '';
              
              if (personId === id) {
                foundPerson = {
                  email: row[0]?.v || '',
                  nombreCompleto: row[1]?.v || '',
                  nickname: row[2]?.v || '',
                  id: row[3]?.v || '',
                  telefono: row[4]?.v || '',
                  nombreContactoEmergencia: row[5]?.v || '',
                  telefonoEmergencia: row[6]?.v || '',
                  direccionEmergencia: row[7]?.v || '',
                  tipoSangre: row[8]?.v || '',
                  alergias: row[9]?.v || '',
                  observaciones: row[10]?.v || ''
                };
                break;
              }
            }
            
            if (foundPerson) {
              setPersonData(foundPerson);
            } else {
              setError(`No se encontr√≥ ning√∫n ciclista con el ID: "${id}".`);
            }
          } catch (err) {
            setError('Error: ' + err.message);
          } finally {
            setLoading(false);
          }
        };

        const resetSOS = () => {
          setPersonData(null);
          setError('');
          setLoading(false);
          setScanning(true);
          startCamera();
        };

        if (loading) {
          return (
            <div className="flex-1 bg-gradient-to-br from-red-50 to-orange-50 flex items-center justify-center p-4">
              <div className="text-center">
                <div className="animate-spin rounded-full h-16 w-16 border-b-4 border-red-600 mx-auto mb-4"></div>
                <p className="text-gray-700 font-medium">Buscando informaci√≥n de emergencia...</p>
              </div>
            </div>
          );
        }

        if (personData) {
          return (
            <div className="flex-1 bg-gradient-to-br from-red-50 to-orange-50 p-4 overflow-y-auto">
              <div className="max-w-2xl mx-auto">
                <div className="bg-white rounded-xl shadow-2xl overflow-hidden border-4 border-red-600">
                  <div className="bg-red-600 text-white p-6">
                    <div className="flex items-center justify-center gap-3">
                      <AlertIcon />
                      <h2 className="text-2xl font-bold">INFORMACI√ìN DE EMERGENCIA</h2>
                    </div>
                  </div>

                  <div className="p-6 space-y-4">
                    <div className="grid grid-cols-2 gap-4">
                      <div className="bg-red-50 p-4 rounded-lg border-2 border-red-300">
                        <p className="text-sm font-semibold text-gray-600 mb-1">NOMBRE COMPLETO</p>
                        <p className="text-xl font-bold text-gray-900">{personData.nombreCompleto}</p>
                      </div>
                      
                      <div className="space-y-2">
                        <div className="bg-red-100 p-3 rounded-lg border-2 border-red-400">
                          <p className="text-xs font-semibold text-gray-600">TIPO DE SANGRE</p>
                          <p className="text-2xl font-bold text-red-700">
                            {personData.tipoSangre === 'LO DESCONOZCO' ? 'n.d.' : (personData.tipoSangre || 'No especificado')}
                          </p>
                        </div>
                        
                        {personData.alergias && (
                          <div className="bg-yellow-100 p-3 rounded-lg border-2 border-yellow-400">
                            <p className="text-xs font-semibold text-gray-600">ALERGIAS</p>
                            <p className="text-sm font-bold text-gray-900">{personData.alergias}</p>
                          </div>
                        )}
                      </div>
                    </div>

                    <div className="border-t-4 border-red-300 pt-4">
                      <h3 className="text-lg font-bold text-red-700 mb-3 flex items-center gap-2">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                          <path d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z"></path>
                        </svg>
                        CONTACTO DE EMERGENCIA
                      </h3>
                      <div className="bg-red-50 p-4 rounded-lg border-2 border-red-300 space-y-2">
                        <div>
                          <p className="text-sm font-semibold text-gray-600">Nombre</p>
                          <p className="text-lg font-bold text-gray-900">{personData.nombreContactoEmergencia}</p>
                        </div>
                        <div>
                          <p className="text-sm font-semibold text-gray-600">Tel√©fono</p>
                          <a href={`tel:${personData.telefonoEmergencia}`} className="text-2xl font-bold text-red-600">
                            {personData.telefonoEmergencia}
                          </a>
                        </div>
                        {personData.direccionEmergencia && (
                          <div>
                            <p className="text-sm font-semibold text-gray-600">Direcci√≥n</p>
                            <p className="text-gray-900">{personData.direccionEmergencia}</p>
                          </div>
                        )}
                      </div>
                    </div>

                    {personData.observaciones && (
                      <div className="bg-orange-50 p-4 rounded-lg border-2 border-orange-300">
                        <p className="text-sm font-semibold text-gray-600 mb-1">OBSERVACIONES M√âDICAS</p>
                        <p className="text-gray-900 font-medium">{personData.observaciones}</p>
                      </div>
                    )}

                    <div className="border-t pt-4 mt-4">
                      <p className="text-xs font-semibold text-gray-500 mb-2">DATOS ADICIONALES</p>
                      <div className="grid grid-cols-2 gap-3 text-sm">
                        <div className="bg-gray-50 p-2 rounded">
                          <p className="text-xs text-gray-500">Nickname</p>
                          <p className="font-semibold text-gray-700">{personData.nickname}</p>
                        </div>
                        <div className="bg-gray-50 p-2 rounded">
                          <p className="text-xs text-gray-500">ID</p>
                          <p className="font-semibold text-gray-700">{personData.id}</p>
                        </div>
                        <div className="bg-gray-50 p-2 rounded">
                          <p className="text-xs text-gray-500">Email</p>
                          <p className="font-semibold text-gray-700 text-xs break-all">{personData.email}</p>
                        </div>
                        <div className="bg-gray-50 p-2 rounded">
                          <p className="text-xs text-gray-500">Tel√©fono Personal</p>
                          <p className="font-semibold text-gray-700">{personData.telefono}</p>
                        </div>
                      </div>
                    </div>

                    <button
                      onClick={resetSOS}
                      className="w-full bg-red-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-red-700 transition mt-4"
                    >
                      Buscar Otro
                    </button>
                  </div>
                </div>
              </div>
            </div>
          );
        }

        if (scanning) {
          return (
            <div className="flex-1 bg-black flex flex-col">
              <div className="flex-1 relative overflow-hidden">
                <video
                  ref={videoRef}
                  className="w-full h-full object-cover"
                  playsInline
                  autoPlay
                  muted
                  style={{ transform: 'scaleX(1)' }}
                />
                <canvas 
                  ref={canvasRef} 
                  style={{ display: 'none' }} 
                />
                
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div className="w-64 h-64 border-4 border-red-500 rounded-lg opacity-75"></div>
                </div>

                <button
                  onClick={() => { stopCamera(); onBack(); }}
                  className="absolute top-4 right-4 bg-red-600 text-white p-3 rounded-full shadow-lg hover:bg-red-700 transition z-10"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>

                <div className="absolute bottom-8 left-0 right-0 text-center z-10">
                  <p className="text-white text-xl font-bold bg-red-600 bg-opacity-75 py-3 px-6 rounded-full inline-block">
                    üö® ESCANEA EL C√ìDIGO QR DE EMERGENCIA
                  </p>
                  {error && (
                    <div className="mt-4 mx-4">
                      <p className="text-white text-sm bg-red-700 bg-opacity-90 py-2 px-4 rounded-lg inline-block">
                        {error}
                      </p>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        return null;
      };

      // Componente Check-In
      const CheckInScreen = ({ onBack }) => {
        const [rutas, setRutas] = useState([]);
        const [allUsers, setAllUsers] = useState([]);
        const [searchRuta, setSearchRuta] = useState('');
        const [rutaSuggestions, setRutaSuggestions] = useState([]);
        const [selectedRuta, setSelectedRuta] = useState(null);
        const [participantes, setParticipantes] = useState([]);
        const [searchParticipante, setSearchParticipante] = useState('');
        const [participanteSuggestions, setParticipanteSuggestions] = useState([]);
        const [scanning, setScanning] = useState(false);
        const [location, setLocation] = useState(null);
        const [loading, setLoading] = useState(false);
        const [showSummary, setShowSummary] = useState(false);
        const [summaryData, setSummaryData] = useState(null);
        const videoRef = useRef(null);
        const canvasRef = useRef(null);
        const streamRef = useRef(null);
        const scanIntervalRef = useRef(null);

        useEffect(() => {
          loadRutas();
          loadUsers();
          getLocation();
        }, []);

        const loadRutas = async () => {
          try {
            const response = await fetch(RUTAS_URL);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
            if (!jsonString) return;
            
            const json = JSON.parse(jsonString[1]);
            const rows = json.table.rows;
            
            const rutasData = rows.map(row => ({
              destino: row.c[0]?.v || '',
              tipo: row.c[1]?.v || '',
              nivel: row.c[2]?.v || '',
              distancia: row.c[3]?.v || '',
              puntoReunion: row.c[4]?.v || ''
            })).filter(r => r.destino);
            
            setRutas(rutasData);
          } catch (error) {
            console.error('Error loading rutas:', error);
          }
        };

        const loadUsers = async () => {
          try {
            const response = await fetch(SHEET_URL);
            const text = await response.text();
            const jsonString = text.match(/google\.visualization\.Query\.setResponse\((.*)\);/);
            if (!jsonString) return;
            
            const json = JSON.parse(jsonString[1]);
            const rows = json.table.rows;
            
            const users = rows.map(row => ({
              email: row.c[0]?.v || '',
              nombreCompleto: row.c[1]?.v || '',
              nickname: row.c[2]?.v || '',
              id: row.c[3]?.v || ''
            })).filter(u => u.id);
            
            setAllUsers(users);
          } catch (error) {
            console.error('Error loading users:', error);
          }
        };

        const getLocation = () => {
          if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(
              (position) => {
                setLocation({
                  lat: position.coords.latitude,
                  lng: position.coords.longitude
                });
              },
              (error) => {
                console.error('Error getting location:', error);
                setLocation({ lat: 0, lng: 0, error: 'No disponible' });
              }
            );
          }
        };

        const handleRutaSearch = (value) => {
          setSearchRuta(value);
          if (value.length > 1) {
            const filtered = rutas.filter(r => 
              r.destino.toLowerCase().includes(value.toLowerCase())
            );
            setRutaSuggestions(filtered);
          } else {
            setRutaSuggestions([]);
          }
        };

        const selectRuta = (ruta) => {
          setSelectedRuta(ruta);
          setSearchRuta('');
          setRutaSuggestions([]);
        };

        const handleParticipanteSearch = (value) => {
          setSearchParticipante(value);
          if (value.length > 1) {
            const filtered = allUsers.filter(u => 
              u.nombreCompleto.toLowerCase().includes(value.toLowerCase()) ||
              u.nickname.toLowerCase().includes(value.toLowerCase()) ||
              u.email.toLowerCase().includes(value.toLowerCase()) ||
              u.id.toLowerCase().includes(value.toLowerCase())
            );
            setParticipanteSuggestions(filtered);
          } else {
            setParticipanteSuggestions([]);
          }
        };

        const addParticipante = (user) => {
          if (!participantes.find(p => p.id === user.id)) {
            setParticipantes([...participantes, user]);
          }
          setSearchParticipante('');
          setParticipanteSuggestions([]);
        };

        const removeParticipante = (id) => {
          setParticipantes(participantes.filter(p => p.id !== id));
        };

        const startScanner = async () => {
          try {
            setScanning(true);
            await new Promise(resolve => setTimeout(resolve, 100));
            
            const stream = await navigator.mediaDevices.getUserMedia({
              video: { 
                facingMode: 'environment',
                width: { ideal: 1280 },
                height: { ideal: 720 }
              }
            });
            
            if (videoRef.current) {
              videoRef.current.srcObject = stream;
              streamRef.current = stream;
              videoRef.current.setAttribute('playsinline', 'true');
              videoRef.current.setAttribute('autoplay', 'true');
              
              videoRef.current.onloadedmetadata = async () => {
                try {
                  await videoRef.current.play();
                  startQRScanning();
                } catch (err) {
                  console.error('Error playing video:', err);
                  stopScanner();
                }
              };
            }
          } catch (err) {
            console.error('Error starting camera:', err);
            alert('No se pudo acceder a la c√°mara');
            setScanning(false);
          }
        };

        const stopScanner = () => {
          if (streamRef.current) {
            streamRef.current.getTracks().forEach(track => track.stop());
            streamRef.current = null;
          }
          if (scanIntervalRef.current) {
            clearInterval(scanIntervalRef.current);
            scanIntervalRef.current = null;
          }
          setScanning(false);
        };

        const startQRScanning = () => {
          if (typeof jsQR === 'undefined') {
            alert('Error: librer√≠a de escaneo no disponible');
            stopScanner();
            return;
          }
          
          scanIntervalRef.current = setInterval(() => {
            scanQR();
          }, 300);
        };

        const scanQR = () => {
          if (!videoRef.current || !canvasRef.current) return;
          if (typeof jsQR === 'undefined') return;

          const video = videoRef.current;
          const canvas = canvasRef.current;
          const context = canvas.getContext('2d');

          if (video.readyState === video.HAVE_ENOUGH_DATA) {
            const width = video.videoWidth;
            const height = video.videoHeight;
            
            if (width > 0 && height > 0) {
              canvas.width = width;
              canvas.height = height;
              context.drawImage(video, 0, 0, width, height);
              const imageData = context.getImageData(0, 0, width, height);
              
              try {
                const code = jsQR(imageData.data, imageData.width, imageData.height, {
                  inversionAttempts: "attemptBoth",
                });

                if (code && code.data) {
                  const id = code.data.trim();
                  const user = allUsers.find(u => u.id === id);
                  if (user) {
                    addParticipante(user);
                    stopScanner();
                  }
                }
              } catch (err) {
                console.error('Error scanning QR:', err);
              }
            }
          }
        };

        const handleIniciarRodada = async () => {
          if (!selectedRuta || participantes.length === 0) {
            alert('Debes seleccionar una ruta y agregar al menos un participante');
            return;
          }

          setLoading(true);

          try {
            const now = new Date();
            const checkInData = {
              action: 'saveCheckIn',
              year: now.getFullYear(),
              month: now.getMonth() + 1,
              day: now.getDate(),
              hora: now.toLocaleTimeString('es-MX', { hour12: false }),
              destino: selectedRuta.destino,
              puntoReunionReal: location ? `${location.lat}, ${location.lng}` : 'No disponible',
              participantes: participantes.map(p => ({
                id: p.id,
                nombre: p.nombreCompleto
              }))
            };

            const formData = new FormData();
            formData.append('data', JSON.stringify(checkInData));

            const response = await fetch(APPS_SCRIPT_URL, {
              method: 'POST',
              body: formData
            });

            const result = await response.json();
            
            if (result.success) {
              setSummaryData({
                destino: selectedRuta.destino,
                distancia: selectedRuta.distancia,
                hora: checkInData.hora,
                totalParticipantes: participantes.length
              });
              setShowSummary(true);
            } else {
              throw new Error(result.error || 'Error desconocido');
            }
          } catch (error) {
            console.error('Error:', error);
            alert('Error al guardar el check-in: ' + error.message);
          } finally {
            setLoading(false);
          }
        };

        if (showSummary && summaryData) {
          return (
            <div className="flex-1 bg-gradient-to-br from-green-50 to-emerald-50 flex items-center justify-center p-4">
              <div className="max-w-md w-full bg-white rounded-2xl shadow-xl p-8 text-center">
                <div className="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                  <svg xmlns="http://www.w3.org/2000/svg" width="40" height="40" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path>
                    <polyline points="22 4 12 14.01 9 11.01"></polyline>
                  </svg>
                </div>
                
                <h2 className="text-2xl font-bold text-gray-900 mb-6">¬°Rodada Iniciada!</h2>
                
                <div className="space-y-4 text-left mb-8">
                  <div className="bg-gray-50 p-4 rounded-lg">
                    <p className="text-sm text-gray-600">Destino</p>
                    <p className="text-lg font-bold text-gray-900">{summaryData.destino}</p>
                  </div>
                  
                  <div className="grid grid-cols-2 gap-4">
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-600">Distancia</p>
                      <p className="text-lg font-bold text-green-600">{summaryData.distancia} km</p>
                    </div>
                    
                    <div className="bg-gray-50 p-4 rounded-lg">
                      <p className="text-sm text-gray-600">Hora</p>
                      <p className="text-lg font-bold text-gray-900">{summaryData.hora}</p>
                    </div>
                  </div>
                  
                  <div className="bg-green-50 p-4 rounded-lg border-2 border-green-200">
                    <p className="text-sm text-gray-600">Participantes</p>
                    <p className="text-2xl font-bold text-green-700">{summaryData.totalParticipantes}</p>
                  </div>
                </div>

                <button
                  onClick={onBack}
                  className="w-full bg-green-600 text-white py-3 rounded-lg font-semibold hover:bg-green-700 transition"
                >
                  Cerrar
                </button>
              </div>
            </div>
          );
        }

        if (scanning) {
          return (
            <div className="flex-1 bg-black flex flex-col">
              <div className="flex-1 relative overflow-hidden">
                <video
                  ref={videoRef}
                  className="w-full h-full object-cover"
                  playsInline
                  autoPlay
                  muted
                />
                <canvas ref={canvasRef} style={{ display: 'none' }} />
                
                <div className="absolute inset-0 flex items-center justify-center pointer-events-none">
                  <div className="w-64 h-64 border-4 border-green-500 rounded-lg opacity-75"></div>
                </div>

                <button
                  onClick={stopScanner}
                  className="absolute top-4 right-4 bg-red-600 text-white p-3 rounded-full shadow-lg z-10"
                >
                  <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                  </svg>
                </button>

                <div className="absolute bottom-8 left-0 right-0 text-center z-10">
                  <p className="text-white text-lg font-bold bg-green-600 bg-opacity-75 py-2 px-4 rounded-full inline-block">
                    Escanea el QR del participante
                  </p>
                </div>
              </div>
            </div>
          );
        }

        return (
          <div className="flex-1 bg-gradient-to-br from-green-50 to-emerald-50 p-4 overflow-y-auto">
            <div className="max-w-2xl mx-auto space-y-6">
              {!selectedRuta ? (
                <div className="bg-white rounded-xl shadow-lg p-6">
                  <h2 className="text-xl font-bold mb-4 text-gray-800">Seleccionar Ruta</h2>
                  
                  <input
                    type="text"
                    value={searchRuta}
                    onChange={(e) => handleRutaSearch(e.target.value)}
                    placeholder="Buscar destino..."
                    className="w-full p-3 border-2 border-gray-300 rounded-lg mb-2 focus:border-green-500 focus:outline-none"
                  />

                  {rutaSuggestions.length > 0 && (
                    <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-60 overflow-y-auto">
                      {rutaSuggestions.map((ruta, idx) => (
                        <div
                          key={idx}
                          onClick={() => selectRuta(ruta)}
                          className="p-4 hover:bg-green-50 cursor-pointer border-b last:border-b-0"
                        >
                          <p className="font-bold text-gray-900">{ruta.destino}</p>
                          <p className="text-sm text-gray-600">{ruta.tipo} ‚Ä¢ {ruta.nivel} ‚Ä¢ {ruta.distancia} km</p>
                        </div>
                      ))}
                    </div>
                  )}

                  <button
                    onClick={onBack}
                    className="w-full mt-4 bg-gray-500 hover:bg-gray-600 text-white py-3 rounded-lg font-semibold"
                  >
                    Cancelar
                  </button>
                </div>
              ) : (
                <>
                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">Datos de la Ruta</h2>
                    
                    <div className="space-y-3">
                      <div className="bg-green-50 p-4 rounded-lg">
                        <p className="text-sm font-semibold text-gray-600">Destino</p>
                        <p className="text-xl font-bold text-gray-900">{selectedRuta.destino}</p>
                      </div>
                      
                      <div className="grid grid-cols-3 gap-3">
                        <div className="bg-gray-50 p-3 rounded-lg">
                          <p className="text-xs text-gray-600">Tipo</p>
                          <p className="font-semibold text-gray-900">{selectedRuta.tipo}</p>
                        </div>
                        <div className="bg-gray-50 p-3 rounded-lg">
                          <p className="text-xs text-gray-600">Nivel</p>
                          <p className="font-semibold text-gray-900">{selectedRuta.nivel}</p>
                        </div>
                        <div className="bg-gray-50 p-3 rounded-lg">
                          <p className="text-xs text-gray-600">Distancia</p>
                          <p className="font-semibold text-green-600">{selectedRuta.distancia} km</p>
                        </div>
                      </div>
                      
                      <div className="bg-blue-50 p-4 rounded-lg">
                        <p className="text-sm font-semibold text-gray-600">Punto de Reuni√≥n</p>
                        <p className="text-gray-900">{selectedRuta.puntoReunion}</p>
                      </div>
                      
                      {location && (
                        <div className="bg-orange-50 p-4 rounded-lg flex items-start gap-2">
                          <MapPin />
                          <div>
                            <p className="text-sm font-semibold text-gray-600">Punto de Salida</p>
                            <p className="text-xs text-gray-700">
                              {location.error || `${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`}
                            </p>
                          </div>
                        </div>
                      )}
                    </div>
                  </div>

                  <div className="bg-white rounded-xl shadow-lg p-6">
                    <h2 className="text-xl font-bold mb-4 text-gray-800">Participantes ({participantes.length})</h2>
                    
                    <div className="flex gap-2 mb-4">
                      <button
                        onClick={startScanner}
                        className="flex-1 bg-green-500 hover:bg-green-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"
                      >
                        <Camera />
                        Escanear QR
                      </button>
                      
                      <button
                        onClick={() => document.getElementById('search-input')?.focus()}
                        className="flex-1 bg-blue-500 hover:bg-blue-600 text-white py-3 rounded-lg font-semibold flex items-center justify-center gap-2"
                      >
                        <Search />
                        Buscar
                      </button>
                    </div>

                    <input
                      id="search-input"
                      type="text"
                      value={searchParticipante}
                      onChange={(e) => handleParticipanteSearch(e.target.value)}
                      placeholder="Buscar por nombre, email, ID o nickname..."
                      className="w-full p-3 border-2 border-gray-300 rounded-lg mb-2 focus:border-blue-500 focus:outline-none"
                    />

                    {participanteSuggestions.length > 0 && (
                      <div className="bg-gray-50 border border-gray-200 rounded-lg max-h-40 overflow-y-auto mb-4">
                        {participanteSuggestions.map((user, idx) => (
                          <div
                            key={idx}
                            onClick={() => addParticipante(user)}
                            className="p-3 hover:bg-blue-50 cursor-pointer border-b last:border-b-0"
                          >
                            <p className="font-semibold text-gray-900">{user.nombreCompleto}</p>
                            <p className="text-xs text-gray-600">@{user.nickname} ‚Ä¢ {user.id}</p>
                          </div>
                        ))}
                      </div>
                    )}

                    {participantes.length > 0 && (
                      <div className="space-y-2 max-h-60 overflow-y-auto">
                        {participantes.map((p, idx) => (
                          <div key={idx} className="flex items-center justify-between bg-green-50 p-3 rounded-lg">
                            <div>
                              <p className="font-semibold text-gray-900">{p.nombreCompleto}</p>
                              <p className="text-xs text-gray-600">@{p.nickname} ‚Ä¢ {p.id}</p>
                            </div>
                            <button
                              onClick={() => removeParticipante(p.id)}
                              className="text-red-500 hover:text-red-700 p-2"
                            >
                              <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
                                <line x1="18" y1="6" x2="6" y2="18"></line>
                                <line x1="6" y1="6" x2="18" y2="18"></line>
                              </svg>
                            </button>
                          </div>
                        ))}
                      </div>
                    )}
                  </div>

                  <div className="flex gap-3">
                    <button
                      onClick={handleIniciarRodada}
                      disabled={loading || participantes.length === 0}
                      className="flex-1 bg-green-600 hover:bg-green-700 text-white py-4 rounded-lg font-bold text-lg disabled:bg-gray-300 disabled:cursor-not-allowed"
                    >
                      {loading ? 'Guardando...' : 'Iniciar Rodada'}
                    </button>
                    
                    <button
                      onClick={onBack}
                      disabled={loading}
                      className="flex-1 bg-red-500 hover:bg-red-600 text-white py-4 rounded-lg font-bold text-lg"
                    >
                      Cancelar
                    </button>
                  </div>
                </>
              )}
            </div>
          </div>
        );
      };

      const renderHome = () => (
        <div className="flex-1 flex flex-col">
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6 flex flex-col justify-center gap-6">
            <button
              onClick={() => setCurrentScreen('checkin')}
              className="pulse-green bg-green-500 hover:bg-green-600 text-white rounded-2xl p-8 shadow-2xl transform transition hover:scale-105 active:scale-95"
            >
              <div className="flex flex-col items-center gap-3">
                <BikeIcon />
                <span className="text-2xl font-bold">Check-In Rodada</span>
                <span className="text-sm opacity-90">Registra tu asistencia</span>
              </div>
            </button>

            <div className="grid grid-cols-2 gap-4">
              <button
                onClick={() => setCurrentScreen('register')}
                className="bg-blue-500 hover:bg-blue-600 text-white rounded-xl p-6 shadow-xl transform transition hover:scale-105 active:scale-95"
              >
                <div className="flex flex-col items-center gap-2">
                  <UserPlusIcon />
                  <span className="text-lg font-bold">Equipo</span>
                </div>
              </button>

              <button
                onClick={() => setCurrentScreen('qrcode')}
                className="bg-purple-500 hover:bg-purple-600 text-white rounded-xl p-6 shadow-xl transform transition hover:scale-105 active:scale-95"
              >
                <div className="flex flex-col items-center gap-2">
                  <QrCodeIcon />
                  <span className="text-lg font-bold">QR Code</span>
                </div>
              </button>
            </div>

            <button
              onClick={() => setCurrentScreen('sos')}
              className="pulse-red bg-red-500 hover:bg-red-600 text-white rounded-2xl p-8 shadow-2xl transform transition hover:scale-105 active:scale-95"
            >
              <div className="flex flex-col items-center gap-3">
                <AlertIcon />
                <span className="text-2xl font-bold">SOS</span>
                <span className="text-sm opacity-90">Emergencia</span>
              </div>
            </button>
          </div>
        </div>
      );

      const renderSettings = () => (
        <div className="flex-1 flex flex-col">
          <div className="flex-1 bg-gradient-to-br from-gray-100 to-gray-200 p-6">
            <div className="bg-white rounded-xl shadow-lg p-6">
              <h2 className="text-xl font-semibold mb-4 text-gray-800">Ajustes</h2>
              <p className="text-gray-600">Configuraci√≥n pr√≥ximamente disponible</p>
            </div>
          </div>
        </div>
      );

      const getSubtitle = () => {
        if (currentScreen === 'checkin') return 'Mobile App - Check-In';
        if (currentScreen === 'register') return 'Mobile App - Equipo';
        if (currentScreen === 'qrcode') return 'Mobile App - QR Code';
        if (currentScreen === 'sos') return 'Mobile App - SOS';
        if (currentScreen === 'settings') return 'Mobile App - Configuraci√≥n';
        return 'Mobile App';
      };

      return (
        <div className="min-h-screen flex flex-col bg-white">
          <div className="bg-white text-black py-6 px-4 text-center border-b-2 border-gray-200 relative">
            <h1 className="text-2xl font-bold">GALLXS - CYCLING CLUB</h1>
            <p className="text-sm font-bold text-gray-700">{getSubtitle()}</p>
            <span className="absolute bottom-2 right-4 text-xs text-gray-400 font-mono">Beta v1.07.014</span>
          </div>

          {currentScreen === 'home' && renderHome()}
          {currentScreen === 'checkin' && <CheckInScreen onBack={() => setCurrentScreen('home')} />}
          {currentScreen === 'register' && <RegisterScreen onBack={() => setCurrentScreen('home')} />}
          {currentScreen === 'qrcode' && <QRCodeScreen onBack={() => setCurrentScreen('home')} />}
          {currentScreen === 'sos' && <SOSScreen onBack={() => setCurrentScreen('home')} />}
          {currentScreen === 'settings' && renderSettings()}

          <div className="bg-white border-t-2 border-gray-200 shadow-lg">
            <div className="flex justify-around items-center py-4">
              <button
                onClick={() => setCurrentScreen('home')}
                className={`flex flex-col items-center gap-1 px-6 py-2 rounded-lg transition ${
                  currentScreen === 'home'
                    ? 'text-green-600 bg-green-50'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <HomeIcon />
                <span className="text-xs font-semibold">Home</span>
              </button>

              <button
                onClick={() => setCurrentScreen('settings')}
                className={`flex flex-col items-center gap-1 px-6 py-2 rounded-lg transition ${
                  currentScreen === 'settings'
                    ? 'text-green-600 bg-green-50'
                    : 'text-gray-600 hover:bg-gray-100'
                }`}
              >
                <SettingsIcon />
                <span className="text-xs font-semibold">Configuraci√≥n</span>
              </button>
            </div>
          </div>
        </div>
      );
    };

    ReactDOM.render(<GallxsApp />, document.getElementById('root'));
  </script>
</body>
</html>
